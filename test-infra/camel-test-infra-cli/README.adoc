:image-name: Fedora
:config-class: src/test/java/org/apache/camel/test/infra/cli/common/CliProperties.java

= Camel JBang CLI test infrastructure

== Overview

This module provides test infrastructure for Camel CLI (Camel JBang) integration tests.
Two service implementations are available:

* *Container-based* (`CliLocalContainerService`) -- builds and runs a Docker container based on {image-name} image with Camel JBang. This is the default.
* *Process-based* (`CliLocalProcessService`) -- runs JBang/Camel CLI directly on the host via `ProcessBuilder`, without Docker. Useful on environments where Docker is not available.

== Service selection

The service implementation is selected via the system property `camel-cli.instance.type`:

* Default (or `local-camel-cli-container`): uses the container-based service
* `local-camel-cli-process`: uses the process-based service (requires JBang pre-installed on the host)

Example using the process-based service:

[source,bash]
----
mvn verify -pl test-infra/camel-test-infra-cli -Pjbang-it-test -Dcamel-cli.instance.type=local-camel-cli-process
----

== Configuration

System variables are defined in link:{config-class}[CliProperties]

=== Common properties (both services)

 - `cli.service.repo` : the repo on github, default `apache/camel`
 - `cli.service.branch` : the branch of the repo on github, default `main`
 - `cli.service.version` : the version of the `camel.jbang.version` defined in the `CamelJBang.java` file, default value is `default`, it means it uses the default values in the file
 - `cli.service.data.folder` : path to local folder used as working directory (container: bind as volume; process: working directory). For the process-based service, a temp directory is created if not set.
 - `cli.service.execute.version` : Camel version set just after service start, default is empty so the version is the one in the branch
 - `cli.service.mvn.repos` : comma separated list of custom Maven repositories, default empty
 - `cli.service.mvn.local` : path to the host folder used as local maven repository (container: mounted as bind volume; process: set via `JBANG_REPO` env var and a temporary `settings.xml` passed with `--maven-settings`)

=== Process-only properties

 - `cli.service.skip.install` : when set to `true`, skips the JBang trust/install/uninstall steps and uses the `camel` command already available on the host, default `false`

=== Container-only properties

 - `cli.service.ssh.password` : ssh password set to access to the container via ssh, default `jbang`
 - `cli.service.extra.hosts` : comma separated host=ip pairs to add in the hosts file
 - `cli.service.trusted.paths` : commas separated paths, relative to the host, of the files containing PEM trusted certificates
 - `cli.service.docker.file` : path to a custom Dockerfile, by default the one in the classpath at _org/apache/camel/test/infra/cli/services/Dockerfile_ will be used

== Process-based service details

The `CliLocalProcessService` replicates the container setup sequence using local JBang commands:

1. `jbang trust add` for the configured repository
2. `jbang app install` to install the Camel CLI app
3. Optionally sets the Camel version and Maven repositories

On shutdown, it runs `jbang app uninstall camel` and cleans up any auto-created temp directory.

*Prerequisites:* JBang must be installed and available on the host. The `~/.jbang/bin` directory is automatically prepended to `PATH` for child processes.

*Limitations:* `getSshPort()` and `getSshPassword()` throw `UnsupportedOperationException`. `getContainerLogs()` returns an empty string.
